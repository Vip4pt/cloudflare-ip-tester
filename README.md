# Cloudflare IP Tester

`cloudflare-ip-tester` 是一个异步 Python 脚本，用于测试 Cloudflare 服务 IP 的可用性、地理位置、延迟和代理功能，筛选 HTTP 状态码 200 的 IP，并将结果按代理可用性分组（可用和不可用）输出，保存到 CSV 文件。

## 功能

- **筛选 Cloudflare IP**：检测指定域名的 IP 是否返回 HTTP 状态码 200，并验证 Cloudflare 服务（通过 `/cdn-cgi/trace` 和响应头）。
- **地理位置查询**：通过 `ip-api.com` 获取 IP 的国家、地区、城市（中文，规范化中国地区表示，如“中国（香港）”）。
- **数据中心检测**：提取 Cloudflare 数据中心（`colo`，如“HKG (香港)”）。
- **代理可用性测试**：通过自定义 API（默认 `https://check.proxyip.cmliussss.net`）测试 IP 是否可用作代理。
- **延迟测试**：使用 `ping3` 测试 IP 平均延迟（毫秒）。
- **结果分组**：按代理可用性分为两组输出（代理可用和不可用），每组按延迟排序。
- **HTTP/2 优化**：Cloudflare 和代理测试请求优先使用 HTTP/2（`ip-api.com` 使用 HTTP 避免请求错误）。
- **CSV 输出**：将所有结果保存到 `results.csv`，包含 IP、延迟、国家、地区、城市、机房、代理可用性、代理端口和时间戳。
- **速率控制**：异步请求限速（2 并发，地理位置请求间隔 2 秒，每 10 个 IP 批次间隔 10 秒）。

## 依赖

- Python 3.8+
- `aiohttp`：异步 HTTP 请求。
- `ping3`：延迟测试。

## 安装


 安装依赖：

   ```bash
   pip install aiohttp ping3
   ```

## 使用说明

1. **配置脚本**：

   - 编辑 `test_cloudflare_ip.py`：

     ```python
     domain = 'your-domain.com'  # 替换为您的 Cloudflare 域名（需启用橙云代理）
     checkip_urls = ["https://check.proxyip.cmliussss.net"]  # 代理测试 API，可以自行搭建使用
     ```

2. **准备 IP 列表**：

   - 创建 `IP.txt`，每行一个 IP 地址：

     ```
     123.254.104.197
     35.206.250.106
     61.216.171.248
     ```


3. **运行脚本**：

   ```bash
   python test_cloudflare_ip.py
   ```

## 输入/输出示例

### 输入

`IP.txt`：

```
123.254.104.197
35.206.250.106
61.216.171.248
```

### 控制台输出

```
IP: 123.254.104.197, 状态码: 200, 地理位置: 中国（香港）, 油尖旺區, 旺角, 机房: NRT (东京), 延迟: 1.40 ms, 代理可用: 是, 代理端口: 443
IP: 35.206.250.106, 状态码: 200, 地理位置: 中国（台湾）, 臺灣省, 臺北市, 机房: NRT (东京), 延迟: 2.61 ms, 代理可用: 否, 代理端口: -1
IP: 61.216.171.248, 状态码: 200, 地理位置: 中国（台湾）, 臺灣省, 臺北市, 机房: TPE (台北), 延迟: 3.20 ms, 代理可用: 否, 代理端口: -1

代理可用的 IP 列表（按延迟从低到高排序）：
IP: 123.254.104.197, 地理位置: 中国（香港）, 油尖旺區, 旺角, 机房: NRT (东京), 延迟: 1.40 ms, 代理可用: 是, 代理端口: 443, 时间戳: 2025-05-22 16:07:00

代理不可用的 IP 列表（按延迟从低到高排序）：
IP: 35.206.250.106, 地理位置: 中国（台湾）, 臺灣省, 臺北市, 机房: NRT (东京), 延迟: 2.61 ms, 代理可用: 否, 代理端口: -1, 时间戳: 2025-05-22 16:07:00
IP: 61.216.171.248, 地理位置: 中国（台湾）, 臺灣省, 臺北市, 机房: TPE (台北), 延迟: 3.20 ms, 代理可用: 否, 代理端口: -1, 时间戳: 2025-05-22 16:07:00

已保存到 results.csv
```

### CSV 输出

`results.csv`：

```
IP,延迟(ms),国家,地区,城市,机房,代理可用,代理端口,时间戳
123.254.104.197,1.40,中国（香港）,油尖旺區,旺角,NRT (东京),是,443,2025-05-22 16:07:00
35.206.250.106,2.61,中国（台湾）,臺灣省,臺北市,NRT (东京),否,-1,2025-05-22 16:07:00
61.216.171.248,3.20,中国（台湾）,臺灣省,臺北市,TPE (台北),否,-1,2025-05-22 16:07:00
```

## 注意事项

- **域名配置**：确保 `domain` 为启用 Cloudflare 域名：

  ```bash
  curl -s -k https://your-domain.com/cdn-cgi/trace
  ```
- **ip-api.com 速率限制**：免费 API 限制 45 次/分钟，脚本已通过 2 秒间隔缓解。
- **IP 范围/CIDR**：当前仅支持单个 IP（不支持 `192.168.0.1/24` 或 `1.1.1.1-1.1.1.10`），请逐个列出 IP。
- **非 Cloudflare IP**：如 `27.36.125.6`，会因无 `/cdn-cgi/trace` 被跳过，建议从 `IP.txt` 移除。
- **代理测试 API**：确保 `check.proxyip.cmliussss.net` 可用，验证：

  ```bash
  curl -s --http2 https://check.proxyip.cmliussss.net/check?proxyip=1.1.1.1
  ```

## 性能

- **处理时间**：100 个 IP 约 300-500 秒（5-8 分钟），2 并发，每 10 个 IP 批次间隔 10 秒。
- **优化**：Cloudflare 和代理测试使用 HTTP/2，`ip-api.com` 使用 HTTP 确保稳定性。

## 未来改进

- 支持 IP 范围/CIDR（通过 `ipaddress` 模块）。
- 分开保存代理可用/不可用结果到不同 CSV 文件。
- 添加日志级别控制（通过 `logging` 模块）。

## 许可证

MIT License